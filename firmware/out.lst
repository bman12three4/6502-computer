ca65 V2.17 - Git 644d623
Main file   : lcdtest.s65
Current file: lcdtest.s65

000000r 1               enable	= $01
000000r 1               tmp1 	= $02
000000r 1               
000000r 1               index	= $03
000000r 1               
000000r 1               RS 	= $10
000000r 1               EN1 	= $20
000000r 1               EN2 	= $40
000000r 1               
000000r 1               VIA	= $4000
000000r 1               VIA_ORA = VIA + 1
000000r 1               VIA_IRA = VIA + 1
000000r 1               VIA_DDRA= VIA + 3
000000r 1               
000000r 1               				; n/c EN2 EN1 RS D7 D6 D5 D4
000000r 1               
000000r 1  A9 FF        start:	lda #$ff		; Set VIA to all outputs
000002r 1  8D 03 40     	sta VIA_DDRA
000005r 1  A0 F0        	ldy #$f0
000007r 1  20 rr rr     	jsr delay
00000Ar 1               
00000Ar 1  A9 60        	lda #<(EN1 | EN2)	; Enable both displays
00000Cr 1  85 01        	sta enable
00000Er 1               
00000Er 1  A9 03        	lda #$3			; Write 0011xxxx 3 times
000010r 1  20 rr rr     	jsr write4
000013r 1  A0 20        	ldy #$20
000015r 1  20 rr rr     	jsr delay
000018r 1  A9 03        	lda #$3
00001Ar 1  20 rr rr     	jsr write4
00001Dr 1  A0 20        	ldy #$20
00001Fr 1  20 rr rr     	jsr delay
000022r 1  A9 03        	lda #$3
000024r 1  20 rr rr     	jsr write4
000027r 1  A0 20        	ldy #$20
000029r 1  20 rr rr     	jsr delay
00002Cr 1  A9 02        	lda #$2			; Write 0010xxxx 1 time
00002Er 1  20 rr rr     	jsr write4		; which sets 4 bit mode
000031r 1  A0 20        	ldy #$20
000033r 1  20 rr rr     	jsr delay
000036r 1               
000036r 1  A9 28        	lda #%00101000		; 2 line, 5x8 characters
000038r 1  20 rr rr     	jsr cmd
00003Br 1  A0 20        	ldy #$20
00003Dr 1  20 rr rr     	jsr delay
000040r 1               
000040r 1  A9 0F        	lda #%000001111		; Display on, cursor on, blinking on
000042r 1  20 rr rr     	jsr cmd
000045r 1  A0 20        	ldy #$20
000047r 1  20 rr rr     	jsr delay
00004Ar 1               
00004Ar 1  A9 01        	lda #%00000001		; Go home
00004Cr 1  20 rr rr     	jsr cmd
00004Fr 1  A0 14        	ldy #20
000051r 1  20 rr rr     	jsr delay
000054r 1               
000054r 1  A9 06        	lda #%00000110		; Move cursor to right, don't shift screen
000056r 1  20 rr rr     	jsr cmd
000059r 1  A0 14        	ldy #20
00005Br 1  20 rr rr     	jsr delay
00005Er 1               
00005Er 1               
00005Er 1  A2 00        	ldx #00
000060r 1  86 03        loop:	stx index		; Print hello world
000062r 1  BD rr rr     	lda string,x
000065r 1  F0 09        	beq end
000067r 1  20 rr rr     	jsr write
00006Ar 1  A6 03        	ldx index
00006Cr 1  E8           	inx
00006Dr 1  4C rr rr     	jmp loop
000070r 1  4C rr rr     end:	jmp end
000073r 1               
000073r 1               
000073r 1  AA           cmd:	tax			; Send data with RS low
000074r 1  AD 01 40     	lda VIA_ORA
000077r 1  29 EF        	and #<~RS
000079r 1  8D 01 40     	sta VIA_ORA
00007Cr 1  8A           	txa
00007Dr 1  4C rr rr     	jmp send
000080r 1               
000080r 1  AA           write:	tax			; Send data with RS high
000081r 1  AD 01 40     	lda VIA_ORA
000084r 1  09 10        	ora #<RS
000086r 1  8D 01 40     	sta VIA_ORA
000089r 1  8A           	txa
00008Ar 1  4C rr rr     	jmp send
00008Dr 1               
00008Dr 1  A8           send:	tay			; save a
00008Er 1  4A           	lsr
00008Fr 1  4A           	lsr
000090r 1  4A           	lsr
000091r 1  4A           	lsr
000092r 1  20 rr rr     	jsr write4		; write high bits
000095r 1  98           	tya
000096r 1  29 0F        	and #$0f
000098r 1  20 rr rr     	jsr write4		; write low bits
00009Br 1  60           	rts
00009Cr 1               
00009Cr 1  85 02        write4: sta tmp1
00009Er 1               
00009Er 1  A5 01        	lda enable     		; E high
0000A0r 1  0D 01 40     	ora VIA_ORA
0000A3r 1  8D 01 40     	sta VIA_ORA
0000A6r 1               
0000A6r 1  A5 02        	lda tmp1       		; Data
0000A8r 1  AD 01 40     	lda VIA_ORA
0000ABr 1  29 F0        	and #$f0
0000ADr 1  05 02        	ora tmp1
0000AFr 1  8D 01 40     	sta VIA_ORA
0000B2r 1               
0000B2r 1  A5 01        	lda enable     		; E low
0000B4r 1  49 FF        	eor #$ff
0000B6r 1  2D 01 40     	and VIA_ORA
0000B9r 1  8D 01 40     	sta VIA_ORA
0000BCr 1               
0000BCr 1  A2 14        	ldx #20
0000BEr 1  CA           @l1:    dex
0000BFr 1  D0 FD        	bne @l1
0000C1r 1               
0000C1r 1  60           	rts
0000C2r 1               
0000C2r 1               
0000C2r 1               
0000C2r 1               
0000C2r 1  A2 FF        delay:	ldx #$ff		; Loop through y
0000C4r 1  CA           delay1:	dex
0000C5r 1  D0 FD        	bne delay1
0000C7r 1  88           delay2:	dey
0000C8r 1  D0 F8        	bne delay
0000CAr 1  60           	rts
0000CBr 1               
0000CBr 1               
0000CBr 1  48 65 6C 6C  string:	.byte "Hello, World!",00
0000CFr 1  6F 2C 20 57  
0000D3r 1  6F 72 6C 64  
0000D8r 1               
